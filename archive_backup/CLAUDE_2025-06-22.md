# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Environment

**Virtual Environment**: Always activate before development:
```bash
.\email-parser-env\Scripts\Activate.ps1  # Windows
# source email-parser-env/bin/activate   # Linux/Mac
```

Verify activation:
```bash
python -c "import sys; print('Virtual env active:', 'email-parser-env' in sys.prefix)"
```

## Essential Commands

### Testing
```bash
# Run full test suite
pytest

# Run with coverage
pytest --cov=email_parser

# Run specific test categories
pytest tests/unit/
pytest tests/integration/
```

### Code Quality
```bash
# Format code
black email_parser tests

# Sort imports
isort email_parser tests

# Type checking
mypy email_parser

# Security checks
bandit -r email_parser
```

### Development Validation
```bash
# Test package imports
python -c "from email_parser.converters import BaseConverter, PDFConverter; print('Imports successful')"

# Test main functionality
python -c "from email_parser import EmailProcessor, ProcessingConfig; print('Core imports successful')"
```

## Architecture Overview

### Core Processing Flow
1. **EmailProcessor** (`email_parser/core/email_processor.py`) - Main orchestrator
2. **MIMEParser** (`email_parser/core/mime_parser.py`) - Email parsing
3. **ComponentExtractor** (`email_parser/core/component_extractor.py`) - Content extraction
4. **Converters** (`email_parser/converters/`) - File conversion (Excel, PDF)

### Key Components

#### Converter Architecture
- **BaseConverter** (`converters/base_converter.py`) - Abstract base with common functionality
- **PDFConverter** (`converters/pdf_converter.py`) - MistralAI OCR integration
- **ExcelConverter** (`converters/excel_converter.py`) - Excel to CSV conversion

#### Configuration System
- **ProcessingConfig** (`core/config.py`) - Main configuration class
- **default.yaml** (`config/default.yaml`) - Default settings including PDF conversion

#### Exception Hierarchy
- **parsing_exceptions.py** - Email parsing errors
- **converter_exceptions.py** - File conversion errors

### Data Flow
```
Email Input â†’ MIMEParser â†’ ComponentExtractor â†’ Converters â†’ Structured Output
```

## Configuration

### MistralAI API Setup (Required for PDF conversion)
```bash
# Windows PowerShell
$env:MISTRALAI_API_KEY = "your-api-key-here"

# Linux/Mac
export MISTRALAI_API_KEY="your-api-key-here"
```

### Processing Configuration
Core settings in `config/default.yaml`:
- `processing.convert_pdf: true` - Enable PDF conversion
- `processing.convert_excel: true` - Enable Excel conversion
- `security.max_attachment_size: 10000000` - 10MB limit
- `pdf_conversion.extraction_mode: "all"` - Extract text and images

## Development Patterns

### Adding New Converters
1. Inherit from `BaseConverter`
2. Implement required abstract methods:
   - `supported_extensions`
   - `supported_mime_types` 
   - `convert()`
3. Add to `converters/__init__.py`
4. Update configuration schema

### Error Handling
- Use specific exception types from `exceptions/`
- Log errors with context using the class logger
- Implement retry logic for external API calls

### Testing Strategy
- Unit tests for individual components
- Integration tests for full workflows
- Mock external dependencies (MistralAI API)
- Test error conditions and edge cases

## File Organization

### Output Structure
```
output/
â”œâ”€â”€ processed_text/          # Extracted text content
â”œâ”€â”€ attachments/            # Original attachments
â”œâ”€â”€ inline_images/          # Embedded images
â”œâ”€â”€ converted_excel/        # CSV conversions
â”œâ”€â”€ converted_pdf/          # PDF to Markdown
â””â”€â”€ metadata.json          # Processing metadata
```

### Module Structure
```
email_parser/
â”œâ”€â”€ core/                   # Main processing logic
â”œâ”€â”€ converters/            # File conversion modules
â”œâ”€â”€ exceptions/            # Custom exception hierarchy
â”œâ”€â”€ security/              # Security validation
â””â”€â”€ utils/                 # Utility functions
```

## Current Status

**Version**: 2.1.0  
**Phase**: 1 Week 2 (API Integration & Testing)

### Completed Features
- âœ… Core email parsing and MIME handling
- âœ… Excel to CSV conversion
- âœ… PDF converter infrastructure with MistralAI integration
- âœ… Comprehensive exception handling
- âœ… Security validation and file size limits

### In Development
- ðŸ”„ MistralAI API integration testing
- ðŸ”„ Enhanced test coverage for converters
- ðŸ”„ ExcelConverter refactoring to BaseConverter pattern

## Project Specifics

### Dependencies
- **Core**: `email-validator`, `pillow`, `pandas`, `openpyxl`
- **PDF**: `mistralai>=1.5.2` (for OCR conversion)
- **Dev**: `pytest`, `black`, `mypy`, `bandit`

### Virtual Environment
The project requires an active virtual environment (`email-parser-env/`) for all development work to ensure proper dependency isolation and MistralAI SDK functionality.

### Archival System
Before modifying existing files, they are archived to `archive/` directory with timestamp-based naming. This provides version history and rollback capability.